BEGIN

DECLARE n Int DEFAULT 0;

DECLARE i Int DEFAULT 0;

DECLARE m Int DEFAULT 0;

DECLARE j Int DEFAULT 0;

declare litemid2 int DEFAULT 0;
declare dateTag date;
declare dateTag2 date;
declare dateadddate datetime;

declare decQty2 decimal(10,2) default 0;
declare strUser varchar(20);
declare strTipe varchar(20);

declare intitem varchar(20) DEFAULT '';
declare strnotrans varchar(20) DEFAULT '';
declare strnotag varchar(20) default '';
declare strop varchar(100) default '';
declare strqc varchar(100) default '';
declare strmesin varchar(20) default '';
declare lnoplan int default 0;
declare lnoplan2 int default 0;
declare lshiftid int default 0;
declare strnotrans2 varchar(20) DEFAULT '';
declare strnotag2 varchar(20) default '';

delete from tbltransnotag2;

SELECT COUNT(y.notag) into n FROM tbltag y where y.adddate2>='2025-08-31' and y.berat<>0;

SET i=0;
WHILE i<n DO       

        SELECT y.notag,y.adddate2,y.addby,y.berat,y.notrans,y.itemid,y.adddate,'','',y.kodemesin,y.noplan,y.shiftid
        into strnotag,dateTag,strUser,decQty2,strnotrans,litemid2,dateadddate,strop,strqc,strmesin
        ,lnoplan,lshiftid FROM tbltag y 
        where y.adddate2>='2025-08-31' and y.berat<>0 LIMIT i,1;

        if strnotag<>'' then
            if lnoplan=0 then
                call updatetbltransnotag2 (dateTag,strnotag,strnotrans,'blowing','','',dateTag,
            dateadddate,struser,'add',strop,strqc,strmesin,litemid2,decQty2,lnoplan,lshiftid,lnoplan); 
            else
                call updatetbltransnotag2 (dateTag,strnotag,strnotrans,'blowing','','',dateTag,
            dateadddate,struser,'add',strop,strqc,strmesin,litemid2,decQty2,lnoplan,lshiftid,lnoplan); 
            end if;
        end if;      
    SET i = i + 1;
END WHILE;

SELECT COUNT(y.notag) into n FROM tblimport y where y.tgltag>='2025-08-31' and y.berat<>0;

SET i=0;
WHILE i<n DO       

        SELECT y.notag,y.tgltag,y.addby,y.berat,y.notrans,y.itemid,y.adddate,'','','',0,1 
        into strnotag,dateTag,strUser,decQty2,strnotrans,litemid2,dateadddate,strop,strqc,strmesin,lnoplan,lshiftid 
        FROM tblimport y 
        where y.tgltag>='2025-08-31' and y.berat<>0 LIMIT i,1;

        if strnotag<>'' then
                call updatetbltransnotag2 (dateTag,strnotag,strnotrans,'blowing','','',dateTag,
            dateadddate,struser,'add',strop,strqc,strmesin,litemid2,decQty2,lnoplan,lshiftid,lnoplan); 
        end if;      
    SET i = i + 1;
END WHILE;

select COUNT(notrans) into n from tbltagjb where (tipejb='belib' or tipejb='belip') and berat<>0;
SET i=0;
WHILE i<n DO 

        SELECT notag,tgljb,editby,berat,notrans,itemid,editdate,'','',kodemesin,0,1,tipejb
        into strnotag,dateTag2,strUser,decQty2,strnotrans,litemid2,dateadddate,strop,strqc,strmesin
        ,lnoplan,lshiftid,strtipe
        FROM tbltagjb 
        where (tipejb='belib' or tipejb='belip') and berat<>0 LIMIT i,1;

        if strnotag<>'' then
                call updatetbltransnotag2 (dateTag2,strnotag,strnotrans,strtipe,'','',dateTag2,
            dateadddate,struser,'add',strop,strqc,strmesin,litemid2,decQty2,lnoplan,lshiftid,lnoplan); 
        end if;
    SET i = i + 1;
END WHILE;

select count(xp.notag) into n from tbltagp xp left join tbltag y on xp.notagblowing=y.notag 
        where xp.adddate2>='2025-08-31' and y.adddate2>='2025-08-31' and xp.berat<>0 and y.berat<>0 ;

SET i=0;
WHILE i<n DO 
        SELECT xp.notag,xp.adddate2,xp.addby,xp.berat,xp.notrans,xp.itemid,xp.adddate,'','',xp.kodemesin,xp.noplan,
        xp.shiftid,y.notag,y.notrans,y.adddate2,y.noplan 
        into strnotag,dateTag,strUser,decQty2,strnotrans,litemid2,dateadddate,strop,strqc,strmesin,lnoplan,lshiftid,strnotag2,strnotrans2,datetag2,lnoplan2
        FROM tbltagp xp left join tbltag y on xp.notagblowing=y.notag 
        where xp.adddate2>='2025-08-31' and y.adddate2>='2025-08-31'
        and xp.berat<>0 and y.berat<>0 LIMIT i,1;

        if strnotag<>'' then
            call updatetbltransnotag2 (dateTag,strnotag,strnotrans,'printing',strnotag2,strnotrans2,dateTag2,
            dateadddate,struser,'add',strop,strqc,strmesin,litemid2,decQty2,lnoplan,lshiftid,lnoplan2); 
        end if;    
    SET i = i + 1;
END WHILE;

select count(xp.notag) into n from tbltagp xp left join tblimport y on xp.notagblowing=y.notag 
        where xp.adddate2>='2025-08-31' and y.tgltag>='2025-08-31' and xp.berat<>0 and y.berat<>0 ;

SET i=0;
WHILE i<n DO 
        SELECT xp.notag,xp.adddate2,xp.addby,xp.berat,xp.notrans,xp.itemid,xp.adddate,'','',xp.kodemesin,xp.noplan,
        xp.shiftid,y.notag,y.notrans,y.tgltag,0
        into strnotag,dateTag,strUser,decQty2,strnotrans,litemid2,dateadddate,strop,strqc,strmesin,lnoplan,
        lshiftid,strnotag2,strnotrans2,datetag2,lnoplan2
        FROM tbltagp xp left join tblimport y on xp.notagblowing=y.notag 
        where xp.adddate2>='2025-08-31' and y.tgltag>='2025-08-31'
        and xp.berat<>0 and y.berat<>0 LIMIT i,1;

        if strnotag<>'' then
            call updatetbltransnotag2 (dateTag,strnotag,strnotrans,'printing',strnotag2,strnotrans2,dateTag2,
            dateadddate,struser,'add',strop,strqc,strmesin,litemid2,decQty2,lnoplan,lshiftid,lnoplan2); 
        end if;    
    SET i = i + 1;
END WHILE;
End
